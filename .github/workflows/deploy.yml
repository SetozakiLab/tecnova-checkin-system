name: Deploy to Proxmox

on:
  push:
    branches:
      - main

# 環境変数
env:
  REGISTRY_HOST: docker-host.local # 例: 192.168.1.10
  IMAGE_NAME: tecnova-checkin-system
jobs:
  build-and-push:
    name: Build and Push Docker Image
    # セルフホストランナーで実行するよう指定
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Build and tag Docker image
        run: |
          docker build -t $REGISTRY_HOST:5000/$IMAGE_NAME:latest .
          docker build -t $REGISTRY_HOST:5000/$IMAGE_NAME:${{ github.sha }} .

      - name: Push Docker image to local registry
        run: |
          docker push $REGISTRY_HOST:5000/$IMAGE_NAME:latest
          docker push $REGISTRY_HOST:5000/$IMAGE_NAME:${{ github.sha }}

  deploy:
    name: Deploy to Portainer
    runs-on: self-hosted
    # build-and-pushジョブが成功したら実行
    needs: build-and-push

    steps:
      - name: Trigger Portainer Webhook
        run: |
          curl -X POST ${{ secrets.PORTAINER_WEBHOOK_URL }}
