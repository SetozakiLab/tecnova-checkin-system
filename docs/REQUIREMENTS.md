# tec-nova 入退場管理システム 要件定義書

**最終更新日:** 2025-09-14

---

## 1. プロジェクト概要

### 1.1. システム名

- tec-nova 入退場管理システム

### 1.2. コンセプト

- **目的**: 小学生から高校生が利用する施設「tec-nova」において、ゲスト（子供）の入退場プロセスをデジタル化し、施設管理者（メンター）の運営負担を軽減する。
- **コア機能**: ゲスト自身による簡単なチェックイン/アウト操作と、メンターによるリアルタイムでの滞在状況の把握。

### 1.3. 開発背景とゴール

- **課題**:
  - 従来のアナログな受付業務（紙への記入や案内など）がメンターの負担になっている。
  - リアルタイムでの滞在者把握が難しく、活動ログ作成に手間がかかる。
  - 情報が紙媒体で管理されており、データの活用や保管が非効率。
- **ゴール**:
  - **メンターの負担軽減**: 受付業務を自動化し、本来のサポート業務に集中できる環境を整える。
  - **運営の効率化**: 情報をデジタル化し、リアルタイムでの滞在者監視とデータ集計を容易にする。
  - **将来への拡張性**: ゲスト情報を ID で一元管理し、将来的な活動ログシステムやその他機能との連携基盤を構築する。

### 1.4. ターゲットユーザー

- **ゲスト（子供）**:
  - 役割: 施設の利用者。
  - 利用シーン: 来場時の新規登録、入退場の手続き。
- **管理者（メンター）**:
  - 役割: 施設の運営・管理者。
  - 利用シーン: リアルタイムでの滞在者状況確認、入退場履歴の集計、ゲスト情報の管理。

---

## 2. 機能要件

### 2.1. 機能一覧 (MVP: Minimum Viable Product)

括弧内ステータス凡例: [✔ 実装済] / [△ 部分実装] / [✖ 未実装]

#### ゲスト向け機能（受付端末）

- **新規ゲスト登録機能** [△ 学年入力拡張中 / メールアドレス入力 UI は一時的にコメントアウト]:
  - 氏名（ニックネーム可）を登録できる。メールアドレスフィールドは DB/API 対応済だが UI は現状非表示。
  - 【拡張】学年 (`grade`) を任意入力（未設定可 / 既存ゲストは NULL 運用）。
    - 対応範囲: 小学 1–6 年 / 中学 1–3 年 / 高校 1–3 年。
    - 内部表現（予定）: Prisma Enum `Grade` (`ES1`..`ES6`,`JH1`..`JH3`,`HS1`..`HS3`) + NULL（未設定）。
  - 登録時にユニークな表示用 ID (displayId) を自動採番し、そのまま自動チェックインする。
- **利用規約同意機能** [✔ 実装済]:
  - 利用規約ページ(`/terms`)で同意 → `?agreed=true` によりフォーム側で同意済表示。
- **入退場（チェックイン/アウト）機能** [✔ 実装済]:
  - ID または名前で検索（部分一致 / 数値は displayId 判定）。
  - 1 画面内で検索と操作（分離した「操作画面」は存在せずコンポーネント切替）。
  - 完了画面 `/checkin/complete` で入退場双方の完了メッセージ表示（10 秒で自動遷移）。

#### 管理者向け機能（管理画面）

- **セキュアなログイン機能** [✔ 実装済 / 2025-09 仕様拡張]:
  - Credentials (NextAuth) によるセッション管理。
  - 2 階層ロール: `SUPER` / `MANAGER`。
    - `SUPER`: 既存スーパーユーザー。全操作可。
    - `MANAGER`: ゲスト削除（および将来の履歴削除）不可。
  - ログイン UI: 既存ユーザー名プルダウン選択 + 「新規ユーザー作成」切替で未登録名入力 → 共有パスワード一致時 MANAGER 自動作成。
  - 新規作成に使用する共有パスワード: 環境変数 `ADMIN_SHARED_PASSWORD`。
  - 既存ユーザーは従来ハッシュ認証（`SUPER` もしくは既存 `MANAGER`）。
- **ダッシュボード（現在の滞在者 / 今日の統計）** [△ 部分実装]:
  - 滞在者一覧/今日の統計はサーバーコンポーネントで都度取得。
  - 自動ポーリングは未実装（手動リフレッシュボタンで更新）。リアルタイム(WebSocket/SSE)は将来対応予定。
- **入退場履歴の管理機能** [△ 部分実装]:
  - 日付範囲 / ゲスト名検索 & ページネーション閲覧は実装済。
  - 手動での記録修正・追加 UI / API は未実装（将来拡張）。
- **ゲスト情報管理（CRUD）機能** [△ 部分実装]:
  - 一覧 + 検索 + 編集/削除(モーダル) 実装。新規作成はゲスト側フローのみ（管理画面からの追加は未提供）。
  - チェックイン中ゲストの削除保護あり。

### 2.2. 将来的な拡張機能

- **活動ログシステムとの連携**: (未) イベント監査・行動ログ基盤。
- **QR コードによる入退場**: (未) `displayId` 生成ロジック再利用予定。
- **統計データのエクスポート**: (未) 履歴検索結果の CSV / TSV ダウンロード。
- **保護者への通知**: (未) 通知チャネル（メール / LINE 等）検討。
- **リアルタイム更新 (WebSocket/SSE)**: (計画) 現在は手動リフレッシュのみ。
- **レート制限 / 監視**: (計画) API 過負荷防止とメトリクス収集。
- **学年自動進級処理**: (計画) 年度切り替え時に `grade` を次学年へバッチ更新（高校 3 年進級不可 → NULL or 卒業フラグ検討）。

### 2.3. 画面フロー

- **ゲスト向け画面**

  1. **トップ画面**: 「はじめての方（新規登録）」「メンバーの方（入退場）」を選択。
  2. **利用規約画面**: (新規登録時) 規約を表示し同意を求める。
  3. **新規登録画面**: 情報を入力する。
  4. **登録完了画面**: 発行された ID などを表示し、入退場画面へ誘導する。
  5. **入退場画面**: 検索と操作（ボタン）は同一ページ内でコンポーネント切替。
  6. **完了画面**: 入場/退場双方を兼用 `/checkin/complete`（10 秒後自動遷移）。

- **管理者向け画面**

  1. **ログイン画面**: ID とパスワードを入力。
  2. **ダッシュボード**: メイン画面。リアルタイム滞在者一覧を表示。
  3. **入退場履歴画面**: 履歴の検索と一覧表示（修正/追加は未実装）。
  4. **ゲスト管理画面**: 一覧 + モーダル編集/削除（詳細個別ページ A005 は未実装）。

- **画面遷移図**

  ```mermaid
  graph TD
      subgraph ゲストフロー
          A[トップ] -->|はじめての方| B(利用規約);
          A -->|メンバーの方| E[入退場画面];
          B --> C[新規登録];
          C --> D[登録完了];
          D --> E;
          E --> F[完了画面];
          F --> A;
      end

      subgraph 管理者フロー
          G[ログイン] --> H[ダッシュボード];
          H --> I[入退場履歴];
          H --> J[ゲスト管理];
          I --> H;
          J --> H;
      end
  ```

### 2.4. データモデル（データベース設計）

- ER 図や詳細なリレーションは別途設計するが、主要なテーブル構成は以下を想定する。

- **`Guest` (ゲスト)**

  - `id`: UUID (主キー, QR コード用)
  - `displayId`: Int (表示用 ID, 自動採番)
  - `name`: String (氏名)
  - `grade`: Grade? (学年 ENUM / NULL = 未設定) ※ 新規追加予定
  - `contact`: String? (メールアドレス, オプショナル)
  - `createdAt`: DateTime (登録日時)
  - `updatedAt`: DateTime (更新日時)

- **`CheckinRecord` (入退場記録)**

  - `id`: UUID (主キー)
  - `guestId`: UUID (外部キー / ON DELETE CASCADE)
  - `checkinAt`: DateTime
  - `checkoutAt`: DateTime?
  - `isActive`: Boolean (滞在中フラグ)
  - （平均滞在時間などの派生値は DB に保持せず API レイヤで算出）

- **`User` (管理者)**
  - `id`: UUID (主キー)
  - `username`: String (ログイン ID, ユニーク)
  - `hashedPassword`: String (ハッシュ化されたパスワード)
  - `role`: Enum (`SUPER` | `MANAGER`) ※ 追加マイグレーションで既存に `SUPER` を付与
  - `createdAt`: DateTime
  - `updatedAt`: DateTime

### 2.4.1. 権限仕様

| 操作                     | SUPER | MANAGER | 備考                       |
| ------------------------ | :---: | :-----: | -------------------------- |
| ゲスト検索/閲覧          |   ✔   |    ✔    |                            |
| ゲスト編集               |   ✔   |    ✔    |                            |
| ゲスト削除               |   ✔   |    ✖    | チェックイン中は双方不可   |
| 入退場履歴閲覧           |   ✔   |    ✔    |                            |
| （将来）履歴削除         |   ✔   |    ✖    | API 未実装（禁止方針先行） |
| MANAGER 新規作成（自身） |   ✔   |    ✔    | 共有 PW 一致時のみ         |
| 権限昇格/ SUPER 追加     |   ✔   |    ✖    | UI 無し（DB 手動）         |

挙動フロー (新規ユーザー):

1. 入力ユーザー名が既存 → そのユーザーのハッシュ認証
2. 未存在 & `ADMIN_SHARED_PASSWORD` 設定 & 入力 PW 一致 → MANAGER 作成
3. 条件不一致 → 失敗

---

## 3. 非機能要件

- **対応環境**:
  - **ゲスト受付端末**: 最新版の Chrome/Safari/Edge が動作するタブレットまたは PC。
  - **管理者端末**: 最新版の Chrome/Safari/Edge が動作する PC またはタブレット。
- **パフォーマンス**:
  - **応答速度**: ゲスト入退場 API は体感 2 秒以内（現在: DB 操作 + バリデーションのみ）。
  - **データ更新**: ダッシュボード自動ポーリングは未実装 → 手動リフレッシュ / ページ再表示で更新。
- **セキュリティ**:
  - **認証**: 管理者機能は全てログインが必須。NextAuth.js 等を利用し、セキュアなセッション管理を行う。
  - **パスワード管理**: パスワードは `bcrypt` 等のアルゴリズムでハッシュ化して保存する。
  - **脆弱性対策**: ORM(Prisma)を利用した SQL インジェクション対策、Next.js の機能を利用した XSS 対策を講じる。
- **UI/UX**:
  - **ゲスト向け画面**: 子供が直感的に操作できるよう、ひらがなを多用し、大きなボタンとイラスト/アイコンを配置する。テキスト入力は最小限に抑える。
  - **管理者向け画面**: 必要な情報（誰がいるか、何人いるか）が一目でわかる、視認性の高いダッシュボードデザインを採用する。
  - **学年入力 UI 指針**: 初期表示は「未設定」。ドロップダウン 2 段 (学校区分 / 年) ではなく 1 ドロップダウン（例: 「小学 1 年」「中学 2 年」…）を優先し選択操作を最短化。内部値は Enum。アクセシビリティ上、学年ラベルはスクリーンリーダーで読み上げ可能な日本語表現とする。

---

## 4. 開発・運用計画

- **開発スコープ**:
  - 第一次リリースとして **2.1. 機能一覧 (MVP)** に記載された機能の実装を最優先とする。
- **技術スタック**:
  - **言語**: TypeScript
  - **フレームワーク**: Next.js (App Router)
  - **UI**: Shadcn/UI, Tailwind CSS
  - **ORM**: Prisma
  - **データベース**: PostgreSQL
  - **認証**: NextAuth.js
  - **インフラ**: 自前サーバー (Linux/Docker)
  - **コード管理**: GitHub

---

## 5. その他・メモ

- ゲストの `displayId` (表示用 ID) は、子供たちが覚えやすいように短い整数にする。
  - 例えば、年と連番を組み合わせた形式`YYXXX`（例: `25001`, `25002`）など。
  - YY: 年（2025 → 25）
  - XXX: 年内の連番（001 から 999 まで）
- ゲストの氏名は、ニックネームや本名のどちらでも登録可能とする。
- ゲストのメールアドレスは任意入力とし、保護者への通知機能は将来的な拡張として検討する。

### 5.1. 実装状況サマリ（2025-09-14 現在）

（学年フィールド Migration / Prisma 反映済。UI: 登録フォーム/編集モーダル反映準備中）

| 項目                         | 状態 | 補足                                     |
| ---------------------------- | ---- | ---------------------------------------- |
| ゲスト登録                   | ✔    | 自動 displayId + 自動チェックイン        |
| メールアドレス UI            | △    | フィールドは存在 / 入力欄は非表示        |
| 利用規約同意                 | ✔    | `/terms` → `?agreed=true` フラグ連携     |
| チェックイン/アウト          | ✔    | 完了統合画面 `/checkin/complete`         |
| ダッシュボード自動更新       | ✖    | 手動リフレッシュのみ（ポーリング未実装） |
| リアルタイム配信             | ✖    | WebSocket/SSE 予定                       |
| 履歴検索                     | ✔    | 日付/名前 + ページネーション             |
| 履歴修正/追加                | ✖    | 未実装（要 API 設計）                    |
| ゲスト編集/削除              | ✔    | モーダル編集。チェックイン中削除不可     |
| 管理画面からの新規ゲスト追加 | ✖    | 要望あれば追加検討                       |
| エクスポート                 | ✖    | CSV/TSV 予定                             |
| QR チェックイン              | ✖    | 予定（displayId 拡張）                   |
| 保護者通知                   | ✖    | 通知チャネル未選定                       |
| レート制限                   | ✖    | 未導入（将来 Upstash/Redis）             |
| 監査ログ                     | ✖    | 未実装                                   |
| 平均滞在時間集計             | ✔    | API で分単位算出                         |
| 学年フィールド               | △    | Prisma 追加済 / UI 組込み進行            |

### 5.3. 学年 (`grade`) 追加仕様詳細

| 項目             | 内容                                                                                           |
| ---------------- | ---------------------------------------------------------------------------------------------- |
| 目的             | 統計分類・年齢帯把握・将来の活動ログ分析基礎                                                   |
| 入力タイミング   | 新規登録フォーム (任意) / 管理画面編集モーダル                                                 |
| 表示形式 (UI)    | 「小学 1 年」「中学 3 年」など日本語表記 / 未設定時は「未設定」                                |
| 内部値           | Enum: `ES1`..`ES6` (Elementary School), `JH1`..`JH3` (Junior High), `HS1`..`HS3` (High School) |
| Null 許容        | 既存データ移行簡略化・未申告運用のため NULL 可                                                 |
| バリデーション   | Enum 一致または NULL. 不正値は 400 VALIDATION_ERROR                                            |
| 既存データ       | 全件 `NULL` 初期化（マイグレーションでカラム追加のみ）                                         |
| 将来拡張         | 年度ロールオーバー時の一括進級バッチ / 卒業処理検討                                            |
| 非機能影響       | 検索クエリ増加想定なし（初期はフィルタ未実装）                                                 |
| マイグレーション | `ALTER TABLE Guest ADD COLUMN grade Grade NULL;` + Enum 追加                                   |
| 統計影響         | ダッシュボード拡張（学年別人数）候補（未実装）                                                 |

#### 5.3.1. UI コンポーネント仕様（概要 / 実装進捗）

- コンポーネント: `<GradeSelect value={grade} onChange=... />`
- 選択肢順序: 未設定 / 小学 1 ～ 6 / 中学 1 ～ 3 / 高校 1 ～ 3
- ラベルと値マッピング:
  - 小学 1 年: ES1 ... 小学 6 年: ES6
  - 中学 1 年: JH1 ... 中学 3 年: JH3
  - 高校 1 年: HS1 ... 高校 3 年: HS3
- 未設定は `null` を返す。
- 進捗: Enum / 型は実装済み、コンポーネントは実装中（管理モーダル・登録フォーム統合予定）。

#### 5.3.2. 移行/ロールバック指針

- 追加のみの非破壊 Migration。ロールバックは `ALTER TABLE ... DROP COLUMN grade; DROP TYPE Grade;`（本番では他オブジェクト依存確認要）。
- 監査ログ未導入のため変更履歴追跡は当面不要。将来は管理画面編集操作を監査対象に含める。

#### 5.3.3. リスクと軽減策

| リスク       | 内容                        | 軽減策                                            |
| ------------ | --------------------------- | ------------------------------------------------- |
| 分類粒度過剰 | 卒業/中退等特殊ケース未定義 | NULL 維持 or 別フラグ追加で対応                   |
| 進級忘れ     | 年度替わりで古い学年のまま  | 年度初回アクセス時自動進級バッチ / 管理 UI バナー |
| 略号可読性   | Enum 値が利用者に直接露出   | API 層で日本語ラベル変換 / UI 側マッピング        |

### 5.2. 次ステップ推奨順

1. ダッシュボード自動更新（短期: クライアント側 5-10 秒ポーリング）
2. 履歴レコード編集 API（監査ログ方針とセット）
3. インデックス追加（`CheckinRecord.isActive`, `CheckinRecord.checkinAt`, `Guest.name` 部分一致用）
4. レート制限 / 監視導入
5. WebSocket/SSE によるリアルタイム化
6. エクスポート / QR / 通知拡張
