# 画面遷移設計書

**最終更新日:** 2025 年 9 月 14 日

---

## 1. 全体画面構成

### 1.1. 画面一覧

実装状況凡例: [✔ 実装済] / [△ 仕様差異あり] / [✖ 未実装]

**ゲスト向け画面（受付端末）**
**UI 要素 (更新)**:

- タイトル: "管理者ログイン"
- ユーザー名プルダウン: 既存 `User.username` 一覧（ログイン前取得）
- 切替リンク: "新規ユーザー作成"クリックでテキスト入力モード（MANAGER 作成）
- 新規入力フィールド: "ユーザー名"（モード=新規時）
- パスワード入力: 共通パスワード or 既存ユーザー固有パスワード
- ボタン: "ログイン"
- 補足テキスト: "新規作成は MANAGER 権限になります"
- エラーメッセージ表示エリア
- G005: 入退場画面（検索 + 操作統合） [△] G006 を統合
- G006: （独立ページなし / 操作コンポーネント化） [✖]
- 共有パスワードは環境変数 `ADMIN_SHARED_PASSWORD` で供給（クライアントへは露出しない）

- A001: ログイン画面 [✔]
- 既存ユーザー選択 + パスワード一致 → A002
- 新規モード + 共有パスワード一致 → MANAGER 作成 → A002
- 条件不一致 → エラー表示
- A003: 入退場履歴画面 [✔] 編集/追加操作は未実装
- A004: ゲスト管理画面 [✔] モーダル編集/削除。新規追加 UI なし
- A005: ゲスト詳細・編集画面 [✖] 未実装（A004 モーダルで代替）

## 2. 詳細画面遷移図

**ヘッダー: ナビゲーション + ログアウト + ロールバッジ (SUPER / MANAGER)**
graph TD
%% ゲスト向け画面フロー
subgraph "ゲスト向け画面"
G001[G001: トップ画面]
G002[G002: 利用規約同意]
G003[G003: 新規登録]
**操作ボタン: 詳細/編集、削除（MANAGER の場合 削除ボタン非表示）**
end

    %% 管理者向け画面フロー
    subgraph "管理者向け画面"
        A001[A001: ログイン]
        A002[A002: ダッシュボード]
        A003[A003: 入退場履歴]
        A004[A004: ゲスト管理]
        A005[A005: ゲスト詳細・編集]
    end

    %% ゲスト画面の遷移
    G001 -->|"はじめての方"| G002
    G001 -->|"メンバーの方"| G005
    G002 -->|"同意する"| G003
    G002 -->|"同意しない"| G001
    G003 -->|"登録"| G004
    G003 -->|"キャンセル"| G001
    G004 -->|"チェックインする"| G005
    G004 -->|"トップに戻る"| G001
    G005 -->|"ゲスト選択→操作コンポーネント"| G007
    G005 -->|"戻る"| G001
    G007 -->|"完了"| G001

    %% 管理者画面の遷移
    A001 -->|"ログイン成功"| A002
    A002 -->|"履歴を見る"| A003
    A002 -->|"ゲスト管理"| A004
    A003 -->|"戻る"| A002
    A004 -->|"戻る"| A002
    %% A005 は未実装（モーダル編集で代替）

    %% ログアウト
    A002 -->|"ログアウト"| A001
    A003 -->|"ログアウト"| A001
    A004 -->|"ログアウト"| A001
    A005 -->|"ログアウト"| A001

```

## 3. 画面詳細設計

### 3.1. ゲスト向け画面

#### G001: トップ画面（ゲスト選択）

**目的**: ゲストの利用区分を選択
**レイアウト**: 大きなボタン 2 つを縦に配置

**UI 要素**:

- タイトル: "tec-nova へようこそ！"
- ボタン 1: "はじめての方（新規登録）"
- ボタン 2: "メンバーの方（入退場）"
- 装飾: 子供向けアイコン・イラスト

**アクション**:

- "はじめての方" → G002（利用規約同意）
- "メンバーの方" → G005（入退場画面）

#### G002: 利用規約同意画面

**目的**: 新規登録前の利用規約同意
**レイアウト**: 規約テキスト + 同意チェックボックス + ボタン

**UI 要素**:

- タイトル: "利用規約"
- 規約テキスト（スクロール可能）
- 同意チェックボックス: "規約に同意します"
- ボタン: "同意して次へ"（チェック必須）
- ボタン: "戻る"

**アクション**:

- "同意して次へ" → G003（新規登録）
- "戻る" → G001（トップ画面）

#### G003: 新規登録画面

**目的**: ゲストの基本情報を登録
**レイアウト**: フォーム形式

**UI 要素**:

- タイトル: "新しいメンバー登録"
- 入力フィールド 1: "お名前（ニックネーム可）" ※必須
- 入力フィールド 2: "メールアドレス（任意）"
- 入力フィールド 3: "学年（任意）" ドロップダウン（初期=未設定）
  - 選択肢: 未設定 / 小学1年〜6年 / 中学1年〜3年 / 高校1年〜3年
  - アクセシビリティ: option value は Enum 値 (ES1..HS3) / ラベルは日本語
- ボタン: "登録する"
- ボタン: "キャンセル"

**バリデーション**:

- 名前: 必須、1-50 文字
- メールアドレス: 任意、有効なメールアドレス形式
- 学年: 任意、指定時は定義済み Enum に一致

**アクション**:

- "登録する" → G004（登録完了）
- "キャンセル" → G001（トップ画面）

#### G004: 登録完了画面

**目的**: 登録完了と発行された ID の表示
**レイアウト**: 完了メッセージ + ID 表示 + 次のアクション

**UI 要素**:

- タイトル: "登録完了！"
- メッセージ: "あなたの ID は [XXX] です"
- 説明: "この ID は次回から使用できます"
- ボタン: "チェックインする"
- ボタン: "トップに戻る"

**アクション**:

- "チェックインする" → G005（入退場画面）
- "トップに戻る" → G001（トップ画面）

#### G005: 入退場画面（検索 + 操作統合）

**目的**: 検索から入退場操作までを 1 画面で完結
**レイアウト**: 検索フォーム + 検索結果リスト + 選択時操作カード (`CheckinActions`)

**UI 要素**:

- タイトル: "誰ですか？"
- 検索フォーム: "お名前または ID で検索"
- 検索結果リスト: 名前 + ID + 選択ボタン
- ボタン: "戻る"

**検索機能**:

- 名前の部分一致検索
- ID の完全一致検索
- リアルタイム検索（入力時）

**アクション**:

- "ゲスト選択" → 同一ページ内で操作カード展開
- "戻る" → G001（トップ画面）

#### (統合) 旧 G006: 入退場操作

独立ページは廃止し、`CheckinActions` コンポーネントで G005 内に操作 UI を埋め込み。
状態表示/ボタン切替はコンポーネント内部ロジック。

#### G007: 操作完了画面（入場/退場兼用）

**目的**: 操作完了メッセージの表示
**レイアウト**: 完了メッセージ + 自動遷移

**UI 要素**:

- チェックイン時: "ようこそ！" + 歓迎メッセージ
- チェックアウト時: "おつかれさま！" + 見送りメッセージ
- 現在時刻の表示
- 10 秒後の自動遷移案内（旧仕様 3 秒 → 実装 10 秒）

**アクション**:

- 10 秒後に自動的に → G001（トップ画面）

### 3.2. 管理者向け画面

#### A001: ログイン画面

**目的**: 管理者認証
**レイアウト**: 中央配置のログインフォーム

**UI 要素**:

- タイトル: "管理者ログイン"
- 入力フィールド 1: "ユーザー名"
- 入力フィールド 2: "パスワード"
- ボタン: "ログイン"
- エラーメッセージ表示エリア

**セキュリティ**:

- パスワード非表示
- ログイン失敗時のエラー表示
- セッション管理

**アクション**:

- "ログイン成功" → A002（ダッシュボード）

#### A002: ダッシュボード（メイン）

**目的**: 現在の滞在状況をリアルタイム表示
**レイアウト**: ヘッダー + 統計情報 + 滞在者一覧

**UI 要素**:

- ヘッダー: ナビゲーション + ログアウト
- 統計カード: 現在の滞在人数、今日の入場者数
- 滞在者一覧テーブル: 名前、ID、入場時刻
- ナビゲーション: 履歴、ゲスト管理へのリンク

**リアルタイム更新**:

- 現状: 自動ポーリングなし（手動リフレッシュボタン）
- 計画: 短周期ポーリング → WebSocket/SSE 導入

**アクション**:

- "履歴を見る" → A003（入退場履歴）
- "ゲスト管理" → A004（ゲスト管理）
- "ログアウト" → A001（ログイン）

#### A003: 入退場履歴画面

**目的**: 過去の入退場記録の検索・表示
**レイアウト**: 検索フォーム + 履歴テーブル

**UI 要素**:

- 検索フォーム: 日付範囲、ゲスト名
- 履歴テーブル: 日時、ゲスト名、種別（入場/退場）
- ページネーション
- エクスポートボタン（将来拡張）

**検索機能**:

- 日付範囲指定
- ゲスト名での絞り込み
- 入場/退場別での絞り込み

**アクション**:

- "戻る" → A002（ダッシュボード）
- "ログアウト" → A001（ログイン）

#### A004: ゲスト管理画面

**目的**: 登録ゲストの一覧と管理
**レイアウト**: 検索フォーム + ゲスト一覧テーブル

**UI 要素**:

- 検索フォーム: 名前、ID 検索（将来 フィルタ: 学年追加予定）
- ゲスト一覧テーブル: 名前、ID、学年(列追加 / 未設定時 '-')、登録日、操作
- 操作ボタン: 詳細/編集、削除
- ページネーション

**アクション**:

- "編集" → モーダルインライン編集
  - モーダル項目: 名前 / メールアドレス / 学年 (同ドロップダウン仕様, 未設定可)
  - 変更送信時: 未設定は `null` を送信
- "削除" → confirm ダイアログ（チェックイン中は disabled）
- "戻る" → A002（ダッシュボード）
  （A005 は未実装で不要ならドキュメントから将来削除検討）

#### A005: ゲスト詳細・編集画面

**目的**: ゲスト情報の詳細表示と編集
**レイアウト**: 詳細情報 + 編集フォーム + 履歴

**UI 要素**:

- ゲスト詳細情報: 名前、ID、登録日、メールアドレス
- 編集フォーム: 名前、メールアドレスの変更
- 入退場履歴: 最近の記録一覧
- ボタン: 保存、削除、戻る

**アクション**:

- "保存" → 更新実行 → A004（ゲスト管理）
- "削除" → 確認ダイアログ → 削除実行 → A004
- "戻る" → A004（ゲスト管理）

## 4. 画面間データ連携

### 4.1. セッションデータ

**ゲスト画面**:

- 新規登録後の一時的なゲスト情報
- 検索結果の一時保持

**管理者画面**:

- ログイン状態の維持
- 検索条件の保持

### 4.2. リアルタイム更新

**対象画面**:

- A002: ダッシュボード（将来ポーリング / 現在手動）
- G005: 入退場画面（入力ごとに検索 API 実行）

**更新方法**:

- 現在: 手動リフレッシュ / 入力イベント駆動 fetch
- 将来: ポーリング → WebSocket / SSE へ移行

## 5. エラーハンドリング

### 5.1. 通信エラー

- ネットワークエラー時の再試行
- オフライン時の適切なメッセージ表示

### 5.2. 入力エラー

- バリデーションエラーの即座表示
- 必須項目の明確な表示

### 5.3. 認証エラー

- セッション切れ時: API 401 → ログイン誘導
- 将来: 401/403 の UI トースト表示改善

## 6. 差異サマリ (2025-09-06)

| 項目             | 旧仕様         | 実装                   | 状態     |
| ---------------- | -------------- | ---------------------- | -------- |
| G005/G006 分離   | 検索/操作分離  | 統合（コンポーネント） | 反映済   |
| 完了画面遷移秒数 | 3 秒           | 10 秒                  | 差異明示 |
| A005 詳細ページ  | 独立ページ     | 未実装 (モーダル代替)  | 要判断   |
| 自動リアルタイム | 5 秒ポーリング | 手動更新               | 予定     |
| メール入力欄     | 表示           | UI 非表示(機能有効)    | 部分     |
| 学年入力欄       | 未記載         | 追加（任意選択）       | 新規     |

### 8. 追加コンポーネント仕様（学年選択）

| 項目 | 内容 |
| ---- | ---- |
| 名称 | GradeSelect |
| 入力 | `value: string | null`, `onChange: (v:string|null)=>void` |
| 選択肢 | 未設定/null, ES1..ES6, JH1..JH3, HS1..HS3 |
| ラベル | 日本語: 小学1年/…/高校3年 |
| フォーカス | キーボード操作 (上下/Enter) |
| アクセシビリティ | ARIA: role="listbox" / option にラベル |
| エラー表示 | 不正値はバリデーション層で 400 応答 |

## 7. 改善候補

1. ダッシュボード短周期ポーリング実装
2. A005 ページの正式廃止 or 復活 (履歴連携拡張時)
3. 完了画面遷移秒数の設定化 (env / 定数)
4. メール入力欄の段階的再表示 (通知機能導入段階で)
5. WebSocket/SSE 設計 (currentGuests / todayStats チャネル)
```
